# Система управления токенами VK API

## Обзор

Реализована полноценная система управления токенами VK API через веб-интерфейс. Теперь токены хранятся в базе данных и могут быть обновлены пользователем без перезапуска системы.

## Возможности

### 1. Хранение токенов в базе данных
- Токены хранятся в таблице `vk_tokens`
- Поддержка маскирования токенов в API ответах
- Отслеживание статуса валидации и времени использования

### 2. Веб-интерфейс управления
- Просмотр статуса всех токенов на дашборде
- Кнопка "Изменить токен" для каждого токена
- Модальное окно для ввода нового токена
- Автоматическая валидация токена после сохранения

### 3. API endpoints
- `GET /api/tokens/` - получить все токены
- `GET /api/tokens/{name}` - получить конкретный токен
- `PUT /api/tokens/{name}` - обновить токен
- `POST /api/tokens/{name}/validate` - валидировать токен
- `POST /api/tokens/validate-all` - валидировать все токены

### 4. Автоматическая валидация
- Проверка токена через VK API
- Получение информации о пользователе
- Определение прав доступа (wall.read, groups.read, messages.read)
- Обновление статуса в базе данных

## Использование

### Обновление токена через интерфейс

1. Откройте дашборд SETKA
2. Найдите раздел "Статус токенов"
3. Нажмите кнопку "Изменить токен" рядом с нужным токеном
4. Введите новый токен в модальном окне
5. Нажмите "Сохранить токен"
6. Система автоматически проверит токен и покажет результат

### Обновление токена через API

```bash
# Обновить токен VALSTAN
curl -X PUT "http://localhost:8000/api/tokens/VALSTAN" \
  -H "Content-Type: application/json" \
  -d '{"token": "vk1.a.новый_токен", "validate": true}'

# Проверить все токены
curl -X POST "http://localhost:8000/api/tokens/validate-all"
```

## Структура базы данных

```sql
CREATE TABLE vk_tokens (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,  -- VALSTAN, OLGA, VITA, etc.
    token TEXT NOT NULL,               -- VK API токен
    is_active BOOLEAN DEFAULT true,    -- Активен ли токен
    last_used TIMESTAMP,               -- Последнее использование
    last_validated TIMESTAMP,          -- Последняя валидация
    validation_status VARCHAR(20) DEFAULT 'unknown', -- valid, invalid, unknown
    error_message TEXT,                -- Сообщение об ошибке
    permissions JSONB,                 -- Права доступа токена
    user_info JSONB,                   -- Информация о пользователе
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Безопасность

### Маскирование токенов
- В API ответах токены показываются в сокращенном виде (первые 20 символов + "...")
- Полные токены доступны только для внутреннего использования

### Валидация
- Все токены проверяются через VK API при обновлении
- Проверяется доступность методов wall.get, groups.get, messages.get
- Ошибки валидации сохраняются в базе данных

### Права доступа
- Система определяет права доступа каждого токена
- Только токены с правами администратора используются для публикации
- Токены без прав используются только для чтения

## Интеграция с существующей системой

### VK Monitoring API
- Обновлен для работы с токенами из базы данных
- Показывает актуальный статус всех токенов
- Отображает информацию о пользователях и правах

### Carousel Manager
- Может использовать токены из базы данных
- Автоматическая ротация между активными токенами
- Отслеживание использования каждого токена

## Мониторинг

### Статистика на дашборде
- Количество активных токенов
- Время последнего использования
- Статус валидации каждого токена
- Кнопки для быстрого управления

### Логирование
- Все операции с токенами логируются
- Ошибки валидации записываются в логи
- Отслеживание изменений в базе данных

## Преимущества новой системы

1. **Гибкость**: Токены можно обновлять без перезапуска системы
2. **Безопасность**: Токены маскируются в интерфейсе
3. **Мониторинг**: Полная видимость статуса всех токенов
4. **Автоматизация**: Автоматическая валидация и проверка прав
5. **Удобство**: Простой веб-интерфейс для управления

## Миграция с конфигурационных файлов

Система автоматически импортирует токены из `config/config_secure.py` в базу данных при первом запуске. После этого все операции с токенами происходят через базу данных.

Конфигурационные файлы остаются для системных настроек, не связанных с токенами VK API.
