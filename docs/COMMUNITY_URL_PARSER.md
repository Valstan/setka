# VK Community URL Parser

## Описание

Система автоматического извлечения ID сообществ VK из различных форматов ввода.

## Обновление (14.10.2025) - v1.1.0

**НОВОЕ:** Поддержка URL с query параметрами!
- ✅ `https://vk.com/club160597747?search_track_code=...`
- ✅ Автоматическое удаление параметров из URL
- ✅ Оптимизация для числовых ID (club/public)

## Обновление (13.10.2025) - v1.0.0

Теперь при добавлении сообщества пользователь может вводить:
- **URL сообщества**: `https://vk.com/43admmalmyzh43`
- **URL с параметрами**: `https://vk.com/club160597747?search_track_code=...`
- **Короткое имя**: `43admmalmyzh43`
- **Числовой ID**: `-123456789` или `123456789`

Система автоматически:
1. Удаляет query параметры (всё после `?`)
2. Распознает формат ввода
3. Извлекает идентификатор
4. Обращается к VK API для получения данных сообщества
5. Проверяет, что объект является сообществом (group)
6. Сохраняет корректный отрицательный ID в базу данных

## Поддерживаемые форматы

| Формат | Пример | Обработка |
|--------|--------|-----------|
| **НОВОЕ:** URL с параметрами | `https://vk.com/club160597747?search_track=...` | Удаляет параметры → Прямое преобразование ID |
| URL с club (числовой) | `https://vk.com/club123456789` | Прямое преобразование: -123456789 (оптимизировано) |
| URL с public (числовой) | `https://vk.com/public123456789` | Прямое преобразование: -123456789 (оптимизировано) |
| Полный URL | `https://vk.com/43admmalmyzh43` | Извлекает screen_name → VK API |
| URL без протокола | `vk.com/43admmalmyzh43` | Извлекает screen_name → VK API |
| Короткое имя | `43admmalmyzh43` | VK API: utils.resolveScreenName |
| Положительный ID | `123456789` | Преобразует в отрицательный: -123456789 |
| Отрицательный ID | `-123456789` | Использует как есть |

## Технические детали

### Backend API

**Файл**: `/home/valstan/SETKA/web/api/communities.py`

**Функция**: `extract_vk_id_from_input(vk_input, vk_api_instance)`

**VK API методы**:
- `utils.resolveScreenName(screen_name)` - для преобразования короткого имени в ID
- `groups.getById(group_id)` - для проверки существования и получения данных группы

**Обработка ошибок**:
- Проверка существования сообщества
- Проверка типа объекта (должен быть 'group')
- Понятные сообщения об ошибках для пользователя

### Frontend

**Файл**: `/home/valstan/SETKA/web/templates/communities.html`

**Изменения**:
- Поле ввода изменено с `type="number"` на `type="text"`
- Обновлены placeholder и подсказки
- Убрана валидация на отрицательное число
- Улучшены сообщения успеха/ошибки

## Примеры использования

### Пример 1: Добавление по URL
```
Ввод: https://vk.com/43admmalmyzh43
Результат: Система извлечет screen_name "43admmalmyzh43", 
          обратится к VK API, получит ID и данные сообщества
```

### Пример 2: Добавление по короткому имени
```
Ввод: 43admmalmyzh43
Результат: Система обратится к VK API utils.resolveScreenName,
          получит ID и данные сообщества
```

### Пример 3: Добавление по ID (обратная совместимость)
```
Ввод: -123456789 или 123456789
Результат: Система сразу использует ID, проверив существование
```

## Преимущества

✅ **Удобство для пользователя**: Можно просто скопировать URL из браузера
✅ **Гибкость**: Поддержка множества форматов
✅ **Валидация**: Автоматическая проверка существования сообщества
✅ **Безопасность**: Проверка типа объекта (только сообщества)
✅ **Обратная совместимость**: Поддержка старого формата с числовым ID

## Тестирование

Все форматы ввода протестированы и работают корректно:
- ✅ 9/9 тестов пройдено
- ✅ Обработка whitespace
- ✅ Различные форматы URL
- ✅ Числовые ID (положительные и отрицательные)

## API Endpoint

**POST** `/api/communities/`

**Request Body**:
```json
{
  "region_id": 1,
  "vk_id": "https://vk.com/43admmalmyzh43",
  "category": "admin",
  "is_active": true
}
```

**Response** (200):
```json
{
  "id": 123,
  "region_id": 1,
  "vk_id": -123456789,
  "screen_name": "43admmalmyzh43",
  "name": "Администрация Мальмыжского района",
  "category": "admin",
  "is_active": true,
  "last_checked": null,
  "posts_count": 0,
  "created_at": "2025-10-13T12:00:00"
}
```

**Error Responses**:
- `400`: Некорректный формат или сообщество не найдено
- `404`: Регион не найден
- `500`: Ошибка VK API или токен недоступен

## Сопутствующие изменения

- Обновлена модель `CommunityCreate`: поле `vk_id` теперь `Union[int, str]`
- Добавлена функция `extract_vk_id_from_input()` для парсинга
- Обновлен UI формы добавления сообщества
- Улучшены сообщения об ошибках

## Автор

Обновление выполнено: 13.10.2025
Проект: SETKA (VK Content Aggregator)

