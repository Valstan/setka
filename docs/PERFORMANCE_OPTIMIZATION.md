# Performance Optimization - SETKA ‚ö°

**–î–∞—Ç–∞:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ  

---

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ú–µ–¥–ª–µ–Ω–Ω—ã–µ API endpoints
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Å–ø–∏–Ω–Ω–µ—Ä—ã –≤ Web UI
- –î–æ–ª–≥–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
- –ü–ª–æ—Ö–æ–π UX

**–ò–∑–º–µ—Ä–µ–Ω–∏—è (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏):**
```
GET /api/regions/               ‚Üí 0.618 —Å–µ–∫—É–Ω–¥
GET /api/communities/?limit=100 ‚Üí 0.895 —Å–µ–∫—É–Ω–¥
GET /api/posts/?limit=20        ‚Üí 0.224 —Å–µ–∫—É–Ω–¥
```

### 2. –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
**CPU:** 57.3% –ø–æ—Å—Ç–æ—è–Ω–Ω–æ (python main.py)  
**Memory:** –¢–æ–ª—å–∫–æ 140MB –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ 1.5GB  

**–ü—Ä–∏—á–∏–Ω—ã:**
- Uvicorn –≤ —Ä–µ–∂–∏–º–µ `--reload` (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã)
- N+1 queries –ø—Ä–æ–±–ª–µ–º–∞ –≤ API
- Cursor Editor –∑–∞–Ω–∏–º–∞–ª ~700MB

### 3. Redirect Loop –Ω–∞ HTTPS
**–°–∏–º–ø—Ç–æ–º—ã:**
- "–°–∞–π—Ç –≤—ã–ø–æ–ª–Ω–∏–ª –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—é —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ä–∞–∑"
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞

**–ü—Ä–∏—á–∏–Ω–∞:**
- –•–æ—Å—Ç–∏–Ω–≥ myjino.ru —Ç–µ—Ä–º–∏–Ω–∏—Ä—É–µ—Ç SSL –Ω–∞ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ
- Nginx –ø—ã—Ç–∞–ª—Å—è –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã

---

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è API - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ N+1 Queries

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞/—Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –¥–µ–ª–∞–ª–∏—Å—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î.

**–ë—ã–ª–æ (N+1 queries):**
```python
for region in regions:
    # –ó–∞–ø—Ä–æ—Å 1
    comm_count = db.execute(
        select(func.count(Community.id)).where(Community.region_id == region.id)
    )
    # –ó–∞–ø—Ä–æ—Å 2
    posts_count = db.execute(
        select(func.count(Post.id)).where(Post.region_id == region.id)
    )
# –ò—Ç–æ–≥–æ: 1 + (N * 2) –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è N —Ä–µ–≥–∏–æ–Ω–æ–≤
# –î–ª—è 14 —Ä–µ–≥–∏–æ–Ω–æ–≤ = 1 + 28 = 29 –∑–∞–ø—Ä–æ—Å–æ–≤!
```

**–°—Ç–∞–ª–æ (Bulk queries):**
```python
# –ó–∞–ø—Ä–æ—Å 1: –í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã
regions = db.execute(select(Region))

# –ó–∞–ø—Ä–æ—Å 2: –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤ –¥–ª—è –í–°–ï–• —Ä–µ–≥–∏–æ–Ω–æ–≤ —Å—Ä–∞–∑—É
comm_counts = db.execute(
    select(Community.region_id, func.count())
    .where(Community.region_id.in_(region_ids))
    .group_by(Community.region_id)
)

# –ó–∞–ø—Ä–æ—Å 3: –°—á–µ—Ç—á–∏–∫–∏ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –í–°–ï–• —Ä–µ–≥–∏–æ–Ω–æ–≤ —Å—Ä–∞–∑—É
posts_counts = db.execute(
    select(Post.region_id, func.count())
    .where(Post.region_id.in_(region_ids))
    .group_by(Post.region_id)
)
# –ò—Ç–æ–≥–æ: 3 –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ 29!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Regions API: **0.618—Å ‚Üí 0.124—Å** (–≤ 5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ!)
- Communities API: **0.895—Å ‚Üí 0.170—Å** (–≤ 5.3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!)

### 2. Production —Ä–µ–∂–∏–º –¥–ª—è Uvicorn

**–ë—ã–ª–æ:**
```bash
python main.py  # –ó–∞–ø—É—Å–∫–∞–µ—Ç uvicorn —Å --reload
```

**–°—Ç–∞–ª–æ:**
```bash
uvicorn main:app --host 127.0.0.1 --port 8000 --workers 1
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚ùå –£–±—Ä–∞–Ω `--reload` (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)
- ‚úÖ –û–¥–∏–Ω worker (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏)
- ‚úÖ Bind —Ç–æ–ª—å–∫–æ –Ω–∞ localhost (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- CPU: **57.3% ‚Üí ~5%** (–≤ 11 —Ä–∞–∑ –º–µ–Ω—å—à–µ!)
- Memory: –¥–æ—Å—Ç—É–ø–Ω–æ **140MB ‚Üí 789MB** (–≤ 5.6 —Ä–∞–∑ –±–æ–ª—å—à–µ!)

### 3. Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è myjino.ru

**–ü–æ–Ω–∏–º–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
```
–ò–Ω—Ç–µ—Ä–Ω–µ—Ç (HTTPS)
    ‚Üì
–ü—Ä–æ–∫—Å–∏ myjino.ru (—Ç–µ—Ä–º–∏–Ω–∏—Ä—É–µ—Ç SSL)
    ‚Üì HTTP
Nginx (–ø–æ—Ä—Ç 80)
    ‚Üì
FastAPI (–ø–æ—Ä—Ç 8000)
```

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±—Ä–∞–ª–∏ SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ nginx (–æ–Ω–∞ –Ω–∞ –ø—Ä–æ–∫—Å–∏ myjino.ru)
- –û—Å—Ç–∞–≤–∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç 80
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `$scheme` –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –ø—Ä–æ–∫—Å–∏

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```nginx
server {
    listen 80 default_server;
    server_name _;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header X-Forwarded-Proto $scheme;
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    }
}
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å API

| Endpoint | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|-----|-------|-----------|
| /api/health/ | 0.03—Å | 0.03—Å | - |
| /api/regions/ | 0.62—Å | **0.12—Å** | **5x** ‚ö° |
| /api/communities/?limit=100 | 0.90—Å | **0.17—Å** | **5.3x** ‚ö° |
| /api/posts/?limit=20 | 0.22—Å | 0.22—Å | - |

### –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

| –†–µ—Å—É—Ä—Å | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|--------|-----|-------|-----------|
| CPU | 57.3% | ~5% | **11x –º–µ–Ω—å—à–µ** |
| RAM –¥–æ—Å—Ç—É–ø–Ω–æ | 140MB | 789MB | **5.6x –±–æ–ª—å—à–µ** |
| RAM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | 71MB | 84MB | –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ |

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|-----|-------|-----------|
| GET 14 —Ä–µ–≥–∏–æ–Ω–æ–≤ | 29 queries | 3 queries | **9.6x –º–µ–Ω—å—à–µ** |
| GET 100 —Å–æ–æ–±—â–µ—Å—Ç–≤ | 201 queries | 3 queries | **67x –º–µ–Ω—å—à–µ** |

---

## üéØ Web UI —Ç–µ–ø–µ—Ä—å

### –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏:
- **Dashboard:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (–≤—Å–µ API < 0.5—Å —Å—É–º–º–∞—Ä–Ω–æ)
- **Regions:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (0.12—Å)
- **Posts:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ (0.22—Å)
- **Communities:** –ë—ã—Å—Ç—Ä–æ (0.17—Å)

### UX —É–ª—É—á—à–µ–Ω–∏—è:
- ‚úÖ –ù–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Å–ø–∏–Ω–Ω–µ—Ä–æ–≤
- ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- ‚úÖ –û—Ç–∑—ã–≤—á–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–∞—Ç—Ç–µ—Ä–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: Bulk Queries

**–í–º–µ—Å—Ç–æ:**
```python
for item in items:
    related_data = db.query(Related).filter(Related.id == item.id).first()
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º:**
```python
item_ids = [item.id for item in items]
related_data = db.query(Related.id, Related.value)\
    .filter(Related.id.in_(item_ids))\
    .all()
related_dict = {row[0]: row[1] for row in related_data}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤
- –ë—ã—Å—Ç—Ä–µ–µ –≤ N —Ä–∞–∑
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

### Production vs Development —Ä–µ–∂–∏–º

**Development (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏):**
```bash
python main.py  # –∏–ª–∏ uvicorn main:app --reload
```
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞
- ‚ùå –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ CPU (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤)
- ‚ùå –ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)

**Production (–¥–ª—è —Ä–∞–±–æ—Ç—ã):**
```bash
uvicorn main:app --host 127.0.0.1 --port 8000 --workers 1
```
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ CPU
- ‚úÖ –ú–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏
- ‚ùå –ù—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

---

## üìù Systemd Service (–¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞)

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞.

**–§–∞–π–ª:** `/etc/systemd/system/setka.service`

```ini
[Unit]
Description=SETKA FastAPI Application
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=valstan
WorkingDirectory=/home/valstan/SETKA
Environment="PATH=/home/valstan/SETKA/venv/bin"
ExecStart=/home/valstan/SETKA/venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000 --workers 1
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**–ö–æ–º–∞–Ω–¥—ã:**
```bash
# –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
sudo systemctl enable setka

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
sudo systemctl start setka

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
sudo systemctl stop setka

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
sudo systemctl restart setka

# –°—Ç–∞—Ç—É—Å
sudo systemctl status setka
```

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
ps aux | grep uvicorn

# –ü–∞–º—è—Ç—å
free -h

# CPU –∏ Memory —Ç–æ–ø
top -b -n 1 | head -n 20

# –°–∫–æ—Ä–æ—Å—Ç—å API
time curl -s http://localhost:8000/api/regions/ > /dev/null

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î (–≤–∫–ª—é—á–∏—Ç—å echo –≤ connection.py)
# echo=True –≤ create_async_engine()
```

---

## üéâ –ò—Ç–æ–≥–∏

### –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ:
- ‚ö° API –≤ **5 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ**
- üíæ –ü–∞–º—è—Ç—å –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞ –≤ **6 —Ä–∞–∑**
- üî• CPU —Å–Ω–∏–∂–µ–Ω –≤ **11 —Ä–∞–∑**
- ‚úÖ Web UI —Ä–∞–±–æ—Ç–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞

### –°–ª–µ–¥—É—é—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] Database indexes –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö JOIN
- [ ] Connection pooling –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] Gzip compression –¥–ª—è API responses
- [ ] CDN –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤

---

**–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** ~20 –º–∏–Ω—É—Ç  
**–≠—Ñ—Ñ–µ–∫—Ç:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 5+ —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ! ‚ö°

