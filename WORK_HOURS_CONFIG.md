# ‚è∞ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ VK –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–î–∞—Ç–∞:** 11 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ

---

## üéØ –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### VK Notifications Check (–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã + –°–æ–æ–±—â–µ–Ω–∏—è)

**–†–∞–±–æ—á–∏–µ —á–∞—Å—ã:** **8:00 - 22:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏**

**–í–Ω–µ —ç—Ç–∏—Ö —á–∞—Å–æ–≤:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è, —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥—ã—Ö–∞–µ—Ç üò¥

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

```python
# –í tasks/notification_tasks.py

WORK_HOURS_START = 8   # 8:00 —É—Ç—Ä–∞
WORK_HOURS_END = 22    # 22:00 –≤–µ—á–µ—Ä–∞
Timezone: Europe/Moscow
```

### –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏:

- **–ö–∞–∂–¥—ã–π —á–∞—Å** (3600 —Å–µ–∫—É–Ω–¥)
- **–¢–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã:** 8:00-22:00 MSK
- **–ù–æ—á—å—é (22:00-8:00):** –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
Celery Beat –∑–∞–ø—É—Å–∫–∞–µ—Ç task –∫–∞–∂–¥—ã–π —á–∞—Å
    ‚Üì
Task –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    ‚Üì
–ï—Å–ª–∏ 8:00 <= hour < 22:00:
    ‚îú‚Üí ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É VK
    ‚îú‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç suggested posts
    ‚îú‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ—Ç unread messages
    ‚îú‚Üí –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram –µ—Å–ª–∏ –µ—Å—Ç—å
    ‚îî‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis
    
–ï—Å–ª–∏ hour < 8:00 –∏–ª–∏ hour >= 22:00:
    ‚îî‚Üí üò¥ –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∏ –ª–æ–≥–∏—Ä—É–µ—Ç "server resting"
```

---

## üìä –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

### –í —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã (8:00-22:00):

```
INFO: üîî Starting VK notifications check (MSK: 15:00)...
INFO: Checking 13 region groups...
INFO: ‚úÖ VK notifications check complete: 8 total
```

### –í–Ω–µ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ (22:00-8:00):

```
INFO: üò¥ Outside work hours (current: 03:00 MSK, work: 8:00-22:00)
INFO: ‚è∏Ô∏è  Skipping VK notifications check (server resting)
```

**API –æ—Ç–≤–µ—Ç:**
```json
{
    "skipped": true,
    "reason": "Outside work hours (03:00 MSK)",
    "work_hours": "8:00-22:00 MSK",
    "next_check": "Next check at 8:00 MSK"
}
```

---

## ‚öôÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤

### –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è:

**–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π:** `tasks/notification_tasks.py`

```python
# –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–∏–µ —á–∞—Å—ã
WORK_HOURS_START = 9   # –ù–∞—á–∏–Ω–∞—Ç—å —Å 9:00
WORK_HOURS_END = 21    # –ó–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å –≤ 21:00

# –ò–ª–∏ —Å–¥–µ–ª–∞—Ç—å –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
WORK_HOURS_START = 0
WORK_HOURS_END = 24
```

**–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Celery:**
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
pkill -f "celery.*beat"
pkill -f "celery.*worker"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞
celery -A celery_app worker --loglevel=info &
celery -A celery_app beat --loglevel=info &
```

---

## üåç Timezone

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:** `Europe/Moscow` (UTC+3)

**–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞:** `pytz`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
import pytz
from datetime import datetime

moscow_tz = pytz.timezone('Europe/Moscow')
now_moscow = datetime.now(moscow_tz)
print(f"Moscow time: {now_moscow.strftime('%H:%M')}")
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ê–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Å—ã:

- **–†–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –≤ —Å—É—Ç–∫–∏:** 14 —á–∞—Å–æ–≤ (8:00-22:00)
- **–ß–∞—Å–æ–≤ –æ—Ç–¥—ã—Ö–∞:** 10 —á–∞—Å–æ–≤ (22:00-8:00)
- **–ü—Ä–æ–≤–µ—Ä–æ–∫ –≤ –¥–µ–Ω—å:** ~14 —Ä–∞–∑ (–∫–∞–∂–¥—ã–π —á–∞—Å –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è)
- **–ü—Ä–æ–≤–µ—Ä–æ–∫ –≤ –Ω–µ–¥–µ–ª—é:** ~98 —Ä–∞–∑

### –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:

- **CPU:** -40% (10 —á–∞—Å–æ–≤ –Ω–æ—á—å—é –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- **VK API calls:** -40% (–º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Rate limits:** –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
- **Server load:** –†–æ–≤–Ω–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å:

```python
from datetime import datetime
import pytz

moscow_tz = pytz.timezone('Europe/Moscow')
now = datetime.now(moscow_tz)
hour = now.hour

print(f"–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è: {now.strftime('%H:%M')}")
print(f"–ß–∞—Å: {hour}")

if 8 <= hour < 22:
    print("‚úÖ –†–∞–±–æ—á–∏–µ —á–∞—Å—ã - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
else:
    print("üò¥ –í–Ω–µ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è")
```

---

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã):

API endpoint `/api/notifications/check-now` –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
curl -X POST http://localhost:8000/api/notifications/check-now
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** API endpoint –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞.  
–¢–æ–ª—å–∫–æ Celery task –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

---

## üìù –õ–æ–≥–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ Celery
tail -f logs/celery.log | grep "notifications"

# –£–≤–∏–¥–∏—à—å –ª–∏–±–æ:
# "üîî Starting VK notifications check" (–≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã)
# "üò¥ Outside work hours" (–Ω–æ—á—å—é)
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤** - —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥—ã—Ö–∞–µ—Ç –Ω–æ—á—å—é
2. **–ú–µ–Ω—å—à–µ VK API calls** - —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ rate limits
3. **–†–∞–∑—É–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–≥–¥–∞ –ª—é–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã
4. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–∞—Å—ã
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–Ω—è—Ç–Ω–æ –∫–æ–≥–¥–∞ –∏ –ø–æ—á–µ–º—É –ø—Ä–æ–ø—É—â–µ–Ω–æ

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

**VK Monitoring (posts scan)** - –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ!

–≠—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Å–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (suggested posts + messages).

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏ VK monitoring - –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–∫—É—é –∂–µ –ª–æ–≥–∏–∫—É –≤ –¥—Ä—É–≥–∏–µ tasks.

---

## üéØ –†–µ–∑—é–º–µ

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

- **–ë—ã–ª–æ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π 24/7
- **–°—Ç–∞–ª–æ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ 8:00-22:00 MSK
- **–≠–∫–æ–Ω–æ–º–∏—è:** 10 —á–∞—Å–æ–≤ –≤ —Å—É—Ç–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç:

‚úÖ **–° 8:00 –¥–æ 22:00** - –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞  
üò¥ **–° 22:00 –¥–æ 8:00** - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (server resting)

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫:

‚úÖ API endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞ (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏)

---

**–°–æ–∑–¥–∞–Ω–æ:** 11 –æ–∫—Ç—è–±—Ä—è 2025, 20:35  
**–ê–≤—Ç–æ—Ä:** AI Assistant (Claude Sonnet 4.5)

üåô **–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ —Å–µ—Ä–≤–µ—Ä—É!** üò¥

