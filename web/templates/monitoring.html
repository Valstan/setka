{% extends "base.html" %}

{% block title %}SETKA - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã{% endblock %}

{% block nav_monitoring %}active{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success bg-opacity-10">
                    <h2 class="mb-0">
                        <i class="bi bi-activity"></i> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã SETKA
                    </h2>
                    <p class="mb-0 mt-2">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title">üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h5>
                    <div id="monitoring-system-status">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <small class="text-muted ms-2">–ó–∞–≥—Ä—É–∑–∫–∞...</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title">üåç –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã</h5>
                    <div id="active-regions">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title">üìù –ü–æ—Å—Ç—ã —Å–µ–≥–æ–¥–Ω—è</h5>
                    <div id="posts-today">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-secondary">
                <div class="card-body text-center">
                    <h5 class="card-title">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h5>
                    <div id="notifications-count">-</div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Resources -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title">üíª CPU</h5>
                    <div id="cpu-usage">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div id="cpu-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title">üß† –ü–∞–º—è—Ç—å</h5>
                    <div id="memory-usage">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div id="memory-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title">üíæ –î–∏—Å–∫</h5>
                    <div id="disk-usage">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div id="disk-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Operations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üîÑ –¢–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h5>
                </div>
                <div class="card-body">
                    <div id="current-operations">
                        <div class="text-center text-muted">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π...</span>
                            </div>
                            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Regions Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üåç –°—Ç–∞—Ç—É—Å —Ä–µ–≥–∏–æ–Ω–æ–≤</h5>
                </div>
                <div class="card-body">
                    <div id="regions-status">
                        <div class="text-center text-muted">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤...</span>
                            </div>
                            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Success/Error Messages -->
<div id="success-message" class="alert alert-success alert-dismissible fade" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
    <i class="bi bi-check-circle"></i>
    <span id="success-text"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div id="error-message" class="alert alert-danger alert-dismissible fade" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
    <i class="bi bi-exclamation-triangle"></i>
    <span id="error-text"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>

<style>
</style>

<script>

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting monitoring...');
    
    // Wait a bit for all elements to be ready
    setTimeout(() => {
        // Test API connection first
        testApiConnection().then(() => {
            loadAllMonitoringData();
        }).catch((error) => {
            console.error('API connection test failed:', error);
            showErrorInStatus('monitoring-system-status', '–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API');
            
            // Fallback: show basic status
            setTimeout(() => {
                const statusElement = document.getElementById('monitoring-system-status');
                if (statusElement && statusElement.innerHTML.includes('spinner')) {
                    statusElement.innerHTML = '<span class="badge bg-warning">‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</span>';
                }
            }, 2000);
        });
    }, 100);
});

async function testApiConnection() {
    try {
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ /api/monitoring/stats...');
        const response = await fetch('/api/monitoring/stats');
        console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
        
        if (!data.success) {
            throw new Error('API returned success: false');
        }
        
        console.log('‚úÖ API connection test successful');
        return data;
    } catch (error) {
        console.error('‚ùå API connection test failed:', error);
        throw error;
    }
}

async function loadAllMonitoringData() {
    try {
        console.log('Loading all monitoring data...');
        
        // Load all monitoring data
        const [statsResponse, operationsResponse, regionsResponse] = await Promise.all([
            fetch('/api/monitoring/stats'),
            fetch('/api/monitoring/operations'),
            fetch('/api/monitoring/regions-status')
        ]);
        
        console.log('Responses received:', {
            stats: statsResponse.status,
            operations: operationsResponse.status,
            regions: regionsResponse.status
        });
        
        const statsData = await statsResponse.json();
        const operationsData = await operationsResponse.json();
        const regionsData = await regionsResponse.json();
        
        console.log('Data parsed:', {
            stats: statsData.success,
            operations: operationsData.success,
            regions: regionsData.success
        });
        
        if (statsData.success) {
            updateSystemStats(statsData.data);
        } else {
            console.error('Stats API error:', statsData);
            showErrorInStatus('monitoring-system-status', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        }
        
        if (operationsData.success) {
            updateCurrentOperations(operationsData.data);
        } else {
            console.error('Operations API error:', operationsData);
            showErrorInStatus('current-operations', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π');
        }
        
        if (regionsData.success) {
            updateRegionsStatus(regionsData.data);
        } else {
            console.error('Regions API error:', regionsData);
            showErrorInStatus('regions-status', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤');
        }
        
        console.log('All monitoring data loaded successfully');
        
    } catch (error) {
        console.error('Error loading monitoring data:', error);
        showErrorInStatus('monitoring-system-status', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
    }
}

function showErrorInStatus(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<span class="text-danger">‚ùå ${message}</span>`;
    }
}

function updateSystemStats(stats) {
    console.log('Updating system stats:', stats);
    
    // Update system status
    const statusElement = document.getElementById('monitoring-system-status');
    if (!statusElement) {
        console.error('Element monitoring-system-status not found');
        return;
    }
    
    let statusBadge = '';
    if (stats.system_status === 'healthy') {
        statusBadge = '<span class="badge bg-success">üü¢ –ó–¥–æ—Ä–æ–≤–∞</span>';
    } else if (stats.system_status === 'warning') {
        statusBadge = '<span class="badge bg-warning">üü° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</span>';
    } else if (stats.system_status === 'critical') {
        statusBadge = '<span class="badge bg-danger">üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ</span>';
    } else {
        statusBadge = '<span class="badge bg-secondary">‚ö™ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>';
    }
    statusElement.innerHTML = statusBadge;
    
    // Update active regions
    const activeRegionsElement = document.getElementById('active-regions');
    if (activeRegionsElement) {
        activeRegionsElement.innerHTML = 
            `<span class="badge bg-info">${stats.active_regions_count}/${stats.total_regions_count}</span>`;
    }
    
    // Update posts today
    const postsTodayElement = document.getElementById('posts-today');
    if (postsTodayElement) {
        postsTodayElement.innerHTML = 
            `<span class="badge bg-warning">${stats.posts_today}</span>`;
    }
    
    // Update system resources
    const cpuElement = document.getElementById('cpu-usage');
    if (cpuElement) {
        cpuElement.innerHTML = `${stats.cpu_usage}%`;
    }
    
    const memoryElement = document.getElementById('memory-usage');
    if (memoryElement) {
        memoryElement.innerHTML = `${stats.memory_usage}%`;
    }
    
    const diskElement = document.getElementById('disk-usage');
    if (diskElement) {
        diskElement.innerHTML = `${stats.disk_usage}%`;
    }
    
    // Update progress bars
    updateProgressBar('cpu-progress', stats.cpu_usage);
    updateProgressBar('memory-progress', stats.memory_usage);
    updateProgressBar('disk-progress', stats.disk_usage);
}

function updateProgressBar(elementId, value) {
    const progressBar = document.getElementById(elementId);
    if (!progressBar) {
        console.error(`Progress bar element ${elementId} not found`);
        return;
    }
    
    progressBar.style.width = `${value}%`;
    
    // Change color based on value
    if (value > 80) {
        progressBar.className = 'progress-bar bg-danger';
    } else if (value > 60) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }
}

function updateCurrentOperations(operationsData) {
    const container = document.getElementById('current-operations');
    
    if (!operationsData.operations || operationsData.operations.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
        return;
    }
    
    // Separate active and completed operations
    const activeOps = operationsData.operations.filter(op => op.status === 'active');
    const completedOps = operationsData.operations.filter(op => op.status !== 'active');
    
    let html = '';
    
    // Show active operations first
    if (activeOps.length > 0) {
        html += '<div class="mb-3">';
        html += '<h6 class="text-success mb-2"><i class="bi bi-play-circle"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h6>';
        html += activeOps.map(operation => `
            <div class="card mb-2 border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <span class="badge ${getOperationBadgeClass(operation.status)}">${operation.type}</span>
                                ${operation.description}
                            </h6>
                            <small class="text-muted">–ù–∞—á–∞—Ç–æ: ${formatTimestamp(operation.timestamp)}</small>
                            ${operation.region ? `<br><small class="text-info">–†–µ–≥–∏–æ–Ω: ${operation.region}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge ${getStatusBadgeClass(operation.status)}">${operation.status}</span>
                        </div>
                    </div>
                    ${operation.details && Object.keys(operation.details).length > 0 ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                ${Object.entries(operation.details).map(([key, value]) => 
                                    `${key}: ${value}`
                                ).join(', ')}
                            </small>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
        html += '</div>';
    }
    
    // Show recent completed operations
    if (completedOps.length > 0) {
        html += '<div>';
        html += '<h6 class="text-secondary mb-2"><i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h6>';
        html += completedOps.slice(0, 10).map(operation => `
            <div class="card mb-2 border-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <span class="badge ${getOperationBadgeClass(operation.status)}">${operation.type}</span>
                                ${operation.description}
                            </h6>
                            <small class="text-muted">
                                ${operation.end_time ? 
                                    `–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${formatTimestamp(operation.end_time)}` : 
                                    `–ù–∞—á–∞—Ç–æ: ${formatTimestamp(operation.timestamp)}`
                                }
                            </small>
                            ${operation.region ? `<br><small class="text-info">–†–µ–≥–∏–æ–Ω: ${operation.region}</small>` : ''}
                            ${operation.duration ? `<br><small class="text-success">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${formatDuration(operation.duration)}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge ${getStatusBadgeClass(operation.status)}">${operation.status}</span>
                        </div>
                    </div>
                    ${operation.details && Object.keys(operation.details).length > 0 ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                ${Object.entries(operation.details).map(([key, value]) => 
                                    `${key}: ${value}`
                                ).join(', ')}
                            </small>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
        html += '</div>';
    }
    
    // Add summary
    html = `
        <div class="mb-3">
            <div class="row">
                <div class="col-md-6">
                    <span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activeOps.length}</span>
                </div>
                <div class="col-md-6">
                    <span class="badge bg-secondary">–í—Å–µ–≥–æ: ${operationsData.total_operations}</span>
                </div>
            </div>
        </div>
    ` + html;
    
    container.innerHTML = html;
}

function updateRegionsStatus(regionsData) {
    const container = document.getElementById('regions-status');
    
    if (!regionsData.regions || regionsData.regions.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">–ù–µ—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤</div>';
        return;
    }
    
    container.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <span class="badge bg-primary">–í—Å–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–æ–≤: ${regionsData.total_regions}</span>
            </div>
            <div class="col-md-6">
                <span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${regionsData.active_regions}</span>
            </div>
        </div>
        <div class="row">
            ${regionsData.regions.map(region => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card ${region.is_active ? 'border-success' : 'border-secondary'}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title mb-1">${region.name}</h6>
                                    <small class="text-muted">${region.code}</small>
                                </div>
                                <span class="badge ${region.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${region.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–∞ –ø–∞—É–∑–µ'}
                                </span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    –°–æ–æ–±—â–µ—Å—Ç–≤: ${region.communities_count} | 
                                    –ü–æ—Å—Ç–æ–≤ —Å–µ–≥–æ–¥–Ω—è: ${region.posts_today}
                                </small>
                                ${region.last_activity ? `
                                    <br><small class="text-info">
                                        –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${formatTimestamp(region.last_activity)}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function getOperationBadgeClass(status) {
    switch(status) {
        case 'active': return 'bg-success';
        case 'scheduled': return 'bg-primary';
        case 'paused': return 'bg-warning';
        case 'error': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'active': return 'bg-success';
        case 'scheduled': return 'bg-primary';
        case 'paused': return 'bg-warning';
        case 'error': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('ru-RU', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function formatDuration(seconds) {
    if (seconds < 60) {
        return `${Math.round(seconds)}—Å`;
    } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.round(seconds % 60);
        return `${minutes}–º ${remainingSeconds}—Å`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}—á ${minutes}–º`;
    }
}



function showSuccess(message) {
    const alert = document.getElementById('success-message');
    document.getElementById('success-text').textContent = message;
    alert.classList.add('show');
    
    setTimeout(() => {
        alert.classList.remove('show');
    }, 5000);
}

function showError(message) {
    const alert = document.getElementById('error-message');
    document.getElementById('error-text').textContent = message;
    alert.classList.add('show');
    
    setTimeout(() => {
        alert.classList.remove('show');
    }, 5000);
}
</script>
{% endblock %}
